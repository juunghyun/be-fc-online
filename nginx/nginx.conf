# Nginx의 동시 접속 처리 설정을 위한 부분입니다. 기본값으로 둡니다.
worker_processes 1;

events {
    worker_connections 1024;
}

http {
    # 응답에 포함될 파일의 유형을 정의합니다. 기본값으로 둡니다.
    include    /etc/nginx/mime.types;
    default_type application/octet-stream;

    server {
        # Azure App Service의 내부 80번 포트에서 모든 요청을 받습니다.
        listen 80;

        # 1. 일반 웹페이지 요청 처리 (프론트엔드)
        # 사용자가 /main, /login 등 API가 아닌 경로로 접속했을 때의 규칙입니다.
        location / {
            # React 빌드 결과물이 위치할 경로입니다.
            root   /usr/share/nginx/html;
            # 기본으로 보여줄 파일을 지정합니다.
            index  index.html index.htm;
            # React Router가 제대로 동작하도록 하는 핵심 설정입니다.
            # (어떤 주소로 접속하든 일단 index.html을 보여줍니다.)
            try_files $uri $uri/ /index.html;
        }

        # 2. API 요청 처리 (백엔드)
        # 주소가 "/api/"로 시작하는 모든 요청에 대한 규칙입니다.
        location /api/ {
            # 이 요청을 뒤에서 실행 중인 백엔드 서버(app:8080)로 전달(proxy)합니다.
            # 'app'은 docker-compose.yml에 정의된 백엔드 서비스의 이름입니다.
            proxy_pass http://app:8080;

            # 요청 헤더를 백엔드 서버에 그대로 전달하기 위한 설정입니다.
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
    }
}